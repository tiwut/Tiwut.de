<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-key="pageTitle">Roadtrip Ziele - Dein Planer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #00f2fe; --secondary-color: #4facfe; --background-start: #0c0c1e;
            --background-end: #1c1c3c; --card-background: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.2); --text-color: #f0f0f0; --text-muted: #a0a0a0;
            --star-color: #ffd700; --star-color-inactive: #555; --success-color: #28a745; --danger-color: #ff4d4d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-start); color: var(--text-color); overflow-x: hidden; }
        .background-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(135deg, var(--background-start), var(--background-end)); animation: background-pan 15s ease-in-out infinite alternate; }
        @keyframes background-pan { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; animation: fadeIn 1s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .logo h1 { font-size: 2.5rem; font-weight: 700; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { text-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color); } to { text-shadow: 0 0 20px var(--secondary-color), 0 0 30px var(--secondary-color); } }
        .header-controls { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .file-operations { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: flex-end;}
        .language-switcher { display: flex; background: var(--card-background); border-radius: 8px; padding: 4px; }
        .lang-btn { background: transparent; border: none; color: var(--text-muted); padding: 0.3rem 0.8rem; cursor: pointer; transition: all 0.3s ease; border-radius: 6px; font-weight: 600; }
        .lang-btn.active { color: var(--background-start); background: var(--primary-color); }
        .card { background: var(--card-background); backdrop-filter: blur(15px); border-radius: 15px; border: 1px solid var(--card-border); padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        h2, h3 { margin-bottom: 1rem; font-weight: 600; border-left: 3px solid var(--primary-color); padding-left: 0.75rem; }
        input[type="text"], input[type="url"], textarea { width: 100%; padding: 0.8rem; background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); border-radius: 8px; color: var(--text-color); font-family: 'Poppins', sans-serif; font-size: 1rem; margin-bottom: 1rem; transition: all 0.3s ease; }
        input[type="text"]:focus, input[type="url"]:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 15px rgba(0, 242, 254, 0.3); }
        textarea { resize: vertical; min-height: 100px; }
        .btn { padding: 0.7rem 1.2rem; border: 1px solid var(--card-border); background: transparent; color: var(--text-color); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .btn:hover { background: var(--card-background); border-color: var(--primary-color); color: var(--primary-color); }
        .btn.btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: var(--background-start); border: none; font-weight: 700; }
        label.btn { cursor: pointer; }
        .importance-selector, .links-container { margin-bottom: 1rem; }
        .stars { display: flex; cursor: pointer; }
        .stars span { font-size: 1.5rem; color: var(--star-color-inactive); transition: all 0.2s ease; }
        .stars span:hover, .stars span.active { color: var(--star-color); transform: scale(1.2); text-shadow: 0 0 10px var(--star-color); }
        #steps-list { display: grid; gap: 1rem; }
        .step-item { display: flex; flex-direction: column; gap: 0.5rem; background: var(--card-background); border: 1px solid var(--card-border); border-left: 5px solid var(--secondary-color); border-radius: 8px; padding: 1rem; animation: slideIn 0.5s ease-out; transition: all 0.3s ease; }
        .step-item.completed { opacity: 0.6; border-left-color: var(--success-color); }
        .step-item.completed .step-header h4 { text-decoration: line-through; color: var(--text-muted); }
        .step-header { display: flex; justify-content: space-between; align-items: center; }
        .step-description { color: var(--text-muted); padding-left: 0.5rem; border-left: 2px solid rgba(255, 255, 255, 0.1); word-break: break-word; }
        .step-item-images { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 1rem; }
        .step-item-images img { height: 80px; width: auto; border-radius: 8px; object-fit: cover; }
        .step-item-links { display: flex; flex-direction: column; gap: 8px; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--card-border); }
        .step-item-links a { color: var(--primary-color); text-decoration: none; word-break: break-all; transition: color 0.2s; }
        .step-item-links a:hover { color: var(--secondary-color); text-decoration: underline; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; transition: transform 0.2s ease; padding: 0.2rem;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal-overlay.visible { display: flex; }
        .modal-content { width: 90%; max-width: 500px; margin: 0; animation: slideIn 0.3s ease-out; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; }
        .image-previews-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem; }
        .image-preview { position: relative; }
        .image-preview img { height: 60px; width: 60px; object-fit: cover; border-radius: 8px; }
        .remove-item-btn { position: absolute; top: -8px; right: -8px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight: bold; font-size: 12px; display: flex; align-items: center; justify-content: center;}
        .link-input-group { display: flex; gap: 10px; align-items: center; }
        .link-input-group input { margin-bottom: 0; }
        .link-input-group .btn-small { padding: 0.5rem; }
        .links-preview-list { list-style: none; margin-top: 1rem; display: flex; flex-direction: column; gap: 8px; }
        .links-preview-list li { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; font-size: 14px; word-break: break-all; }
        #pdf-content-wrapper { position: absolute; left: -9999px; top: 0; display: none; }
        .pdf-container { width: 210mm; padding: 15mm; background-color: #1a1a2e; color: #f0f0f0; font-family: 'Poppins', sans-serif; }
        .pdf-header { padding: 20px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 10px; text-align: center; margin-bottom: 25px; }
        .pdf-header h1 { color: #1a1a2e; font-size: 28px; margin: 0; font-weight: 700; word-break: break-word; }
        .pdf-section h2 { font-size: 22px; color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 15px; }
        .pdf-main-goal p { font-size: 14px; line-height: 1.6; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; color: #f0f0f0; white-space: pre-wrap; word-break: break-word; }
        .pdf-step-item { background: rgba(0,0,0,0.2); border-left: 4px solid var(--secondary-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; page-break-inside: avoid; }
        .pdf-step-item h3 { font-size: 16px; margin: 0 0 5px 0; display: flex; justify-content: space-between; align-items: center; color: #f0f0f0; word-break: break-word; }
        .pdf-step-item .stars { font-size: 16px; color: var(--star-color); flex-shrink: 0; margin-left: 10px;}
        .pdf-step-item p { font-size: 12px; color: var(--text-muted); margin: 0 0 10px 0; padding-left: 10px; border-left: 2px solid rgba(255,255,255,0.1); white-space: pre-wrap; word-break: break-word; }
        .pdf-step-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .pdf-step-images img { max-width: 30%; border-radius: 8px; }
        .pdf-step-links { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--card-border); }
        .pdf-step-links a { color: var(--primary-color); font-size: 12px; text-decoration: none; word-break: break-all; }
        .pdf-footer { text-align: center; margin-top: 30px; padding-top: 15px; font-size: 10px; color: var(--text-muted); border-top: 1px solid var(--card-border); }
    </style>
</head>
<body>

    <div class="background-animation"></div>

    <div id="edit-modal-overlay" class="modal-overlay">
        <div id="edit-modal" class="card modal-content">
            <h3 data-i18n-key="editStepTitle"></h3>
            <input type="text" id="edit-step-title" data-i18n-key="placeholderStepTitle">
            <textarea id="edit-step-desc" data-i18n-key="placeholderStepDesc"></textarea>
            <div class="importance-selector">
                <label data-i18n-key="importanceLabel"></label>
                <div id="edit-stars" class="stars">
                    <span data-value="1">★</span><span data-value="2">★</span><span data-value="3">★</span><span data-value="4">★</span><span data-value="5">★</span>
                </div>
                <input type="hidden" id="edit-step-importance">
            </div>
            <div class="image-upload-container">
                <label for="edit-step-image" class="btn" data-i18n-key="imageChangeButton"></label>
                <input type="file" id="edit-step-image" accept="image/*" multiple hidden>
                <div id="edit-image-previews" class="image-previews-container"></div>
            </div>
             <div class="links-container">
                <label data-i18n-key="linksLabel"></label>
                <div class="link-input-group">
                    <input type="url" id="edit-step-link-input" data-i18n-key="placeholderLink">
                    <button id="add-edit-link-button" class="btn btn-small" data-i18n-key="addButton"></button>
                </div>
                <ul id="edit-links-preview-list" class="links-preview-list"></ul>
            </div>
            <div class="modal-actions">
                <button id="cancel-edit-button" class="btn" data-i18n-key="cancelButton"></button>
                <button id="save-edit-button" class="btn btn-primary" data-i18n-key="saveButton"></button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo"><h1 data-i18n-key="mainHeader"></h1></div>
            <div class="header-controls">
                <div id="language-switcher" class="language-switcher">
                    <button data-lang="de" class="lang-btn active">DE</button><button data-lang="en" class="lang-btn">EN</button><button data-lang="es" class="lang-btn">ES</button>
                </div>
                <div class="file-operations">
                    <button id="export-pdf-button" class="btn"><span data-i18n-key="exportPdfButton"></span></button>
                    <button id="save-button" class="btn btn-primary"><span data-i18n-key="savePlanButton"></span></button>
                    <label for="file-loader" class="btn"><span data-i18n-key="loadPlanButton"></span></label>
                    <input type="file" id="file-loader" accept=".zip" hidden>
                </div>
            </div>
        </header>

        <main>
            <section class="card main-destination-card">
                <h2 data-i18n-key="mainGoalHeader"></h2>
                <input type="text" id="main-destination-title" data-i18n-key="placeholderMainGoalTitle">
                <textarea id="main-destination-desc" data-i18n-key="placeholderMainGoalDesc"></textarea>
            </section>
            <section class="steps-section">
                <h2 data-i18n-key="plannedStepsHeader"></h2>
                <div id="steps-list"></div>
            </section>
            <section class="card add-step-form">
                <h3 data-i18n-key="addStepHeader"></h3>
                <input type="text" id="new-step-title" data-i18n-key="placeholderStepTitle">
                <textarea id="new-step-desc" data-i18n-key="placeholderStepDesc"></textarea>
                <div class="importance-selector">
                    <label data-i18n-key="importanceLabel"></label>
                    <div id="new-stars" class="stars">
                        <span data-value="1">★</span><span data-value="2">★</span><span data-value="3">★</span><span data-value="4">★</span><span data-value="5">★</span>
                    </div>
                    <input type="hidden" id="new-step-importance" value="3">
                </div>
                <div class="image-upload-container">
                    <label for="new-step-image" class="btn" data-i18n-key="imageButton"></label>
                    <input type="file" id="new-step-image" accept="image/*" multiple hidden>
                    <div id="new-image-previews" class="image-previews-container"></div>
                </div>
                <div class="links-container">
                    <label data-i18n-key="linksLabel"></label>
                    <div class="link-input-group">
                        <input type="url" id="new-step-link-input" data-i18n-key="placeholderLink">
                        <button id="add-new-link-button" class="btn btn-small" data-i18n-key="addButton"></button>
                    </div>
                    <ul id="new-links-preview-list" class="links-preview-list"></ul>
                </div>
                <button id="add-step-button" class="btn btn-primary" data-i18n-key="addButton"></button>
            </section>
        </main>
    </div>

    <div id="pdf-content-wrapper">
        <div class="pdf-container">
            <div class="pdf-header"><h1 id="pdf-main-title"></h1></div>
            <div class="pdf-section pdf-main-goal"><h2 id="pdf-main-goal-header"></h2><p id="pdf-main-desc"></p></div>
            <div class="pdf-section pdf-steps-section"><h2 id="pdf-steps-header"></h2><div id="pdf-steps-list"></div></div>
            <div class="pdf-footer"><p>Generated by Roadtrip Goals Planner</p></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const translations = {
                de: { pageTitle: "Roadtrip Ziele - Dein Planer", mainHeader: "Roadtrip Ziele", savePlanButton: "Plan als ZIP speichern", loadPlanButton: "Plan laden (.zip)", mainGoalHeader: "Dein Hauptziel", plannedStepsHeader: "Geplante Schritte & Ziele", placeholderMainGoalTitle: "Titel des Roadtrips...", placeholderMainGoalDesc: "Beschreibe hier dein großes Abenteuer...", addStepHeader: "Neuen Schritt hinzufügen", placeholderStepTitle: "Titel des Schritts...", placeholderStepDesc: "Details zum Schritt...", importanceLabel: "Wichtigkeit:", addButton: "Hinzufügen", emptyState: "Noch keine Schritte geplant. Füge deinen ersten Schritt hinzu!", editStepTitle: "Schritt bearbeiten", cancelButton: "Abbrechen", saveButton: "Speichern", alertStepTitle: "Bitte gib einen Titel für den Schritt ein.", alertInvalidFile: "Die Datei hat ein ungültiges Format oder 'config.tiwut' fehlt.", alertReadFileError: "Fehler beim Lesen der ZIP-Datei.", stepCompleted: "Erledigt", stepDelete: "Löschen", stepEdit: "Bearbeiten", exportPdfButton: "PDF Exportieren", imageButton: "Bilder hinzufügen", imageChangeButton: "Bilder hinzufügen/ändern", linksLabel: "Links (URL)", placeholderLink: "https://beispiel.de", alertInvalidUrl: "Bitte eine gültige URL eingeben (beginnend mit http:// oder https://)." },
                en: { pageTitle: "Roadtrip Goals - Your Planner", mainHeader: "Roadtrip Goals", savePlanButton: "Save Plan as ZIP", loadPlanButton: "Load Plan (.zip)", mainGoalHeader: "Your Main Destination", plannedStepsHeader: "Planned Steps & Goals", placeholderMainGoalTitle: "Title of the roadtrip...", placeholderMainGoalDesc: "Describe your great adventure here...", addStepHeader: "Add a New Step", placeholderStepTitle: "Title of the step...", placeholderStepDesc: "Details about the step...", importanceLabel: "Importance:", addButton: "Add", emptyState: "No steps planned yet. Add your first step!", editStepTitle: "Edit Step", cancelButton: "Cancel", saveButton: "Save", alertStepTitle: "Please enter a title for the step.", alertInvalidFile: "Invalid file format or 'config.tiwut' is missing.", alertReadFileError: "Error reading the ZIP file.", stepCompleted: "Completed", stepDelete: "Delete", stepEdit: "Edit", exportPdfButton: "Export PDF", imageButton: "Add Images", imageChangeButton: "Add/Change Images", linksLabel: "Links (URL)", placeholderLink: "https://example.com", alertInvalidUrl: "Please enter a valid URL (starting with http:// or https://)." },
                es: { pageTitle: "Metas del Roadtrip - Tu Planificador", mainHeader: "Metas del Roadtrip", savePlanButton: "Guardar Plan como ZIP", loadPlanButton: "Cargar Plan (.zip)", mainGoalHeader: "Tu Destino Principal", plannedStepsHeader: "Pasos y Metas Planificados", placeholderMainGoalTitle: "Título del roadtrip...", placeholderMainGoalDesc: "Describe tu gran aventura aquí...", addStepHeader: "Añadir Nuevo Paso", placeholderStepTitle: "Título del paso...", placeholderStepDesc: "Detalles sobre el paso...", importanceLabel: "Importancia:", addButton: "Añadir", emptyState: "Aún no hay pasos planeados. ¡Añade tu primer paso!", editStepTitle: "Editar Paso", cancelButton: "Cancelar", saveButton: "Guardar", alertStepTitle: "Por favor, introduce un título para el paso.", alertInvalidFile: "Formato de archivo no válido o falta 'config.tiwut'.", alertReadFileError: "Error al leer el archivo ZIP.", stepCompleted: "Completado", stepDelete: "Eliminar", stepEdit: "Editar", exportPdfButton: "Exportar PDF", imageButton: "Añadir Imágenes", imageChangeButton: "Añadir/Cambiar Imágenes", linksLabel: "Enlaces (URL)", placeholderLink: "https://ejemplo.com", alertInvalidUrl: "Por favor, introduce una URL válida (empezando con http:// o https://)." },
            };
            let currentLang = 'de';
            let tripData = { mainDestination: { title: '', description: '' }, steps: [] };
            let newStepImages = []; let newStepLinks = [];
            let editStepImages = []; let editStepLinks = [];
            let editingStepIndex = null;

            const DOM = {
                mainTitleInput: document.getElementById('main-destination-title'), mainDescInput: document.getElementById('main-destination-desc'),
                stepsList: document.getElementById('steps-list'), newStepTitleInput: document.getElementById('new-step-title'),
                newStepDescInput: document.getElementById('new-step-desc'), newStepImportanceInput: document.getElementById('new-step-importance'),
                addStepButton: document.getElementById('add-step-button'), saveButton: document.getElementById('save-button'),
                fileLoader: document.getElementById('file-loader'), newStarsContainer: document.getElementById('new-stars'),
                languageSwitcher: document.getElementById('language-switcher'), editModalOverlay: document.getElementById('edit-modal-overlay'),
                editStepTitleInput: document.getElementById('edit-step-title'), editStepDescInput: document.getElementById('edit-step-desc'),
                editStepImportanceInput: document.getElementById('edit-step-importance'), editStarsContainer: document.getElementById('edit-stars'),
                saveEditButton: document.getElementById('save-edit-button'), cancelEditButton: document.getElementById('cancel-edit-button'),
                exportPdfButton: document.getElementById('export-pdf-button'), newStepImageInput: document.getElementById('new-step-image'),
                newImagePreviewsContainer: document.getElementById('new-image-previews'), editStepImageInput: document.getElementById('edit-step-image'),
                editImagePreviewsContainer: document.getElementById('edit-image-previews'), newStepLinkInput: document.getElementById('new-step-link-input'),
                addNewLinkButton: document.getElementById('add-new-link-button'), newLinksPreviewList: document.getElementById('new-links-preview-list'),
                editStepLinkInput: document.getElementById('edit-step-link-input'), addEditLinkButton: document.getElementById('add-edit-link-button'),
                editLinksPreviewList: document.getElementById('edit-links-preview-list')
            };
            
            const applyTranslations = (lang) => {
                currentLang = lang; document.documentElement.lang = lang;
                document.querySelectorAll('[data-i18n-key]').forEach(el => {
                    const key = el.getAttribute('data-i18n-key'); const translation = translations[lang][key];
                    if (translation) {
                        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = translation;
                        else el.innerText = translation;
                    }
                });
                document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
                localStorage.setItem('preferredLanguage', lang); renderSteps();
            };

            const detectAndSetLanguage = () => {
                const preferredLang = localStorage.getItem('preferredLanguage'); const browserLang = navigator.language.split('-')[0];
                const lang = preferredLang || (translations[browserLang] ? browserLang : 'en'); applyTranslations(lang);
            };

            const renderImagePreviews = (container, images) => {
                container.innerHTML = '';
                images.forEach((imgData, index) => {
                    const previewWrapper = document.createElement('div'); previewWrapper.className = 'image-preview';
                    previewWrapper.innerHTML = `<img src="${imgData.data}" alt="Vorschau"><button class="remove-item-btn" data-index="${index}">×</button>`;
                    container.appendChild(previewWrapper);
                });
            };

            const renderLinkPreviews = (container, links) => {
                container.innerHTML = '';
                links.forEach((link, index) => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span>${link}</span><button class="remove-item-btn" data-index="${index}">×</button>`;
                    container.appendChild(listItem);
                });
            };

            const handleImageSelection = (files, imagesArray, previewContainer) => {
                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = (e) => { imagesArray.push({ data: e.target.result, name: file.name }); renderImagePreviews(previewContainer, imagesArray); };
                    reader.readAsDataURL(file);
                }
            };

            const handleLinkAddition = (inputElement, linksArray, previewContainer) => {
                const url = inputElement.value.trim();
                if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                    linksArray.push(url);
                    renderLinkPreviews(previewContainer, linksArray);
                    inputElement.value = '';
                } else { alert(translations[currentLang].alertInvalidUrl); }
            };

            const handlePreviewRemove = (e, itemsArray, renderFn, previewContainer) => {
                if (e.target.classList.contains('remove-item-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    itemsArray.splice(index, 1);
                    renderFn(previewContainer, itemsArray);
                }
            };
            
            DOM.newStepImageInput.addEventListener('change', (e) => handleImageSelection(e.target.files, newStepImages, DOM.newImagePreviewsContainer));
            DOM.newImagePreviewsContainer.addEventListener('click', (e) => handlePreviewRemove(e, newStepImages, renderImagePreviews, DOM.newImagePreviewsContainer));
            DOM.addNewLinkButton.addEventListener('click', () => handleLinkAddition(DOM.newStepLinkInput, newStepLinks, DOM.newLinksPreviewList));
            DOM.newLinksPreviewList.addEventListener('click', (e) => handlePreviewRemove(e, newStepLinks, renderLinkPreviews, DOM.newLinksPreviewList));

            DOM.editStepImageInput.addEventListener('change', (e) => handleImageSelection(e.target.files, editStepImages, DOM.editImagePreviewsContainer));
            DOM.editImagePreviewsContainer.addEventListener('click', (e) => handlePreviewRemove(e, editStepImages, renderImagePreviews, DOM.editImagePreviewsContainer));
            DOM.addEditLinkButton.addEventListener('click', () => handleLinkAddition(DOM.editStepLinkInput, editStepLinks, DOM.editLinksPreviewList));
            DOM.editLinksPreviewList.addEventListener('click', (e) => handlePreviewRemove(e, editStepLinks, renderLinkPreviews, DOM.editLinksPreviewList));

            const renderSteps = () => {
                DOM.stepsList.innerHTML = '';
                if (tripData.steps.length === 0) { DOM.stepsList.innerHTML = `<p class="empty-state">${translations[currentLang].emptyState}</p>`; }
                tripData.steps.forEach((step, index) => {
                    const stepElement = document.createElement('div');
                    stepElement.className = `step-item ${step.completed ? 'completed' : ''}`;
                    stepElement.dataset.index = index;
                    const importanceStars = '★'.repeat(step.importance) + '☆'.repeat(5 - step.importance);
                    const imagesHtml = step.images && step.images.length > 0 ? `<div class="step-item-images">${step.images.map(img => `<img src="${img.data}" alt="${step.title}">`).join('')}</div>` : '';
                    const linksHtml = step.links && step.links.length > 0 ? `<div class="step-item-links">${step.links.map(link => `<a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a>`).join('')}</div>` : '';

                    stepElement.innerHTML = `
                        <div class="step-header">
                            <h4>${step.title}</h4>
                            <div class="step-actions">
                                <span title="${translations[currentLang].importanceLabel} ${step.importance}/5">${importanceStars}</span>
                                <label title="${translations[currentLang].stepCompleted}"><input type="checkbox" class="complete-checkbox" ${step.completed ? 'checked' : ''}></label>
                                <button class="action-btn edit-btn" title="${translations[currentLang].stepEdit}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-2.086.27l-7.5 7.5a.5.5 0 0 1-.354.146H.5a.5.5 0 0 1-.5-.5v-2.793a.5.5 0 0 1 .146-.353l7.5-7.5a1.5 1.5 0 0 1 2.086-.272zM12.207 2.5 13.5 3.793 14.793 2.5 13.5 1.207 12.207 2.5zm1.586 3L10.5 3.207 4 9.707V12h2.293l6.5-6.5-1.293-1.293z"/></svg></button>
                                <button class="action-btn delete-btn" title="${translations[currentLang].stepDelete}">✖</button>
                            </div>
                        </div>
                        <p class="step-description">${step.description || ''}</p>
                        ${imagesHtml}
                        ${linksHtml}
                    `;
                    DOM.stepsList.appendChild(stepElement);
                });
            };
            
            const updateStars = (container, hiddenInput, value) => {
                const stars = container.querySelectorAll('span');
                stars.forEach(star => star.classList.toggle('active', star.dataset.value <= value));
                hiddenInput.value = value;
            };

            const addStep = () => {
                const title = DOM.newStepTitleInput.value.trim();
                if (!title) { alert(translations[currentLang].alertStepTitle); return; }
                const newStep = { title: title, description: DOM.newStepDescInput.value.trim(), importance: parseInt(DOM.newStepImportanceInput.value), completed: false, images: [...newStepImages], links: [...newStepLinks] };
                tripData.steps.push(newStep);
                DOM.newStepTitleInput.value = ''; DOM.newStepDescInput.value = ''; newStepImages = []; newStepLinks = [];
                renderImagePreviews(DOM.newImagePreviewsContainer, newStepImages);
                renderLinkPreviews(DOM.newLinksPreviewList, newStepLinks);
                updateStars(DOM.newStarsContainer, DOM.newStepImportanceInput, 3);
                renderSteps();
            };

            const openEditModal = (index) => {
                editingStepIndex = index;
                const step = tripData.steps[index];
                DOM.editStepTitleInput.value = step.title;
                DOM.editStepDescInput.value = step.description;
                updateStars(DOM.editStarsContainer, DOM.editStepImportanceInput, step.importance);
                editStepImages = step.images ? [...step.images] : [];
                editStepLinks = step.links ? [...step.links] : [];
                renderImagePreviews(DOM.editImagePreviewsContainer, editStepImages);
                renderLinkPreviews(DOM.editLinksPreviewList, editStepLinks);
                DOM.editModalOverlay.classList.add('visible');
            };

            const closeEditModal = () => {
                DOM.editModalOverlay.classList.remove('visible');
                editingStepIndex = null; editStepImages = []; editStepLinks = [];
                renderImagePreviews(DOM.editImagePreviewsContainer, editStepImages);
                renderLinkPreviews(DOM.editLinksPreviewList, editStepLinks);
            };

            const saveEditedStep = () => {
                if (editingStepIndex === null) return;
                const title = DOM.editStepTitleInput.value.trim();
                if (!title) { alert(translations[currentLang].alertStepTitle); return; }
                const step = tripData.steps[editingStepIndex];
                step.title = title; step.description = DOM.editStepDescInput.value.trim();
                step.importance = parseInt(DOM.editStepImportanceInput.value);
                step.images = [...editStepImages]; step.links = [...editStepLinks];
                renderSteps(); closeEditModal();
            };

            const saveTripAsZip = () => {
                const zip = new JSZip();
                tripData.mainDestination.title = DOM.mainTitleInput.value;
                tripData.mainDestination.description = DOM.mainDescInput.value;
                
                const dataToSave = JSON.parse(JSON.stringify(tripData));
                const imageFolder = zip.folder("images");
                
                dataToSave.steps.forEach(step => {
                    if (step.images && step.images.length > 0) {
                        step.imageFileNames = [];
                        step.images.forEach(img => {
                            const base64Data = img.data.split(',')[1];
                            imageFolder.file(img.name, base64Data, { base64: true });
                            step.imageFileNames.push(img.name);
                        });
                        delete step.images;
                    }
                });
                
                zip.file("config.tiwut", JSON.stringify(dataToSave, null, 2));

                zip.generateAsync({ type: "blob" }).then(content => {
                    const fileName = (tripData.mainDestination.title.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'mein_roadtrip') + ".zip";
                    saveAs(content, fileName);
                });
            };

            const loadTripFromZip = (file) => {
                JSZip.loadAsync(file).then(zip => {
                    const configFile = zip.file("config.tiwut");
                    if (!configFile) { alert(translations[currentLang].alertInvalidFile); return; }
                    configFile.async("string").then(content => {
                        const loadedData = JSON.parse(content);
                        const imagePromises = [];
                        
                        loadedData.steps.forEach(step => {
                            step.images = [];
                            if (step.imageFileNames && step.imageFileNames.length > 0) {
                                step.imageFileNames.forEach(fileName => {
                                    const imageFile = zip.file(`images/${fileName}`);
                                    if (imageFile) {
                                        const promise = imageFile.async("base64").then(base64 => {
                                            const extension = fileName.split('.').pop().toLowerCase();
                                            step.images.push({ data: `data:image/${extension};base64,${base64}`, name: fileName });
                                        });
                                        imagePromises.push(promise);
                                    }
                                });
                            }
                        });
                        
                        Promise.all(imagePromises).then(() => {
                            tripData = loadedData;
                            DOM.mainTitleInput.value = tripData.mainDestination.title;
                            DOM.mainDescInput.value = tripData.mainDestination.description;
                            renderSteps();
                        });
                    });
                }).catch(err => { alert(translations[currentLang].alertReadFileError); console.error("Error:", err); });
            };
            
            const exportToPdf = () => {
                const wrapper = document.getElementById('pdf-content-wrapper');
                const elementToPrint = wrapper.querySelector('.pdf-container');
                const pdfTitle = DOM.mainTitleInput.value || "Roadtrip Plan";
                
                document.getElementById('pdf-main-title').innerText = pdfTitle;
                document.getElementById('pdf-main-goal-header').innerText = translations[currentLang].mainGoalHeader;
                document.getElementById('pdf-steps-header').innerText = translations[currentLang].plannedStepsHeader;
                document.getElementById('pdf-main-desc').innerText = DOM.mainDescInput.value || " ";
                const pdfStepsList = document.getElementById('pdf-steps-list');
                pdfStepsList.innerHTML = '';
                tripData.steps.forEach(step => {
                    const stars = '★'.repeat(step.importance);
                    const imagesHtml = step.images && step.images.length > 0 ? `<div class="pdf-step-images">${step.images.map(img => `<img src="${img.data}" alt="${step.title}">`).join('')}</div>` : '';
                    const linksHtml = step.links && step.links.length > 0 ? `<div class="pdf-step-links">${step.links.map(link => `<a href="${link}" target="_blank">${link}</a>`).join('')}</div>` : '';
                    const stepDiv = document.createElement('div');
                    stepDiv.className = `pdf-step-item ${step.completed ? 'completed' : ''}`;
                    stepDiv.innerHTML = `<h3><span>${step.title}</span><span class="stars">${stars}</span></h3><p>${step.description || ' '}</p>${imagesHtml}${linksHtml}`;
                    pdfStepsList.appendChild(stepDiv);
                });
                
                wrapper.style.display = 'block';

                const opt = { margin: 0, filename: `${pdfTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                
                html2pdf().from(elementToPrint).set(opt).save().then(() => { wrapper.style.display = 'none'; });
            };

            const setupInitialState = () => {
                DOM.addStepButton.addEventListener('click', addStep);
                DOM.saveButton.addEventListener('click', saveTripAsZip);
                DOM.exportPdfButton.addEventListener('click', exportToPdf);
                DOM.fileLoader.addEventListener('change', (e) => e.target.files.length && loadTripFromZip(e.target.files[0]));
                DOM.languageSwitcher.addEventListener('click', (e) => e.target.tagName === 'BUTTON' && applyTranslations(e.target.dataset.lang));
                DOM.stepsList.addEventListener('click', (e) => {
                    const stepItem = e.target.closest('.step-item'); if (!stepItem) return;
                    const index = parseInt(stepItem.dataset.index);
                    if (e.target.closest('.delete-btn')) { tripData.steps.splice(index, 1); renderSteps(); } 
                    else if (e.target.closest('.edit-btn')) { openEditModal(index); } 
                    else if (e.target.classList.contains('complete-checkbox')) { tripData.steps[index].completed = e.target.checked; stepItem.classList.toggle('completed', e.target.checked); }
                });
                DOM.newStarsContainer.addEventListener('click', (e) => e.target.tagName === 'SPAN' && updateStars(DOM.newStarsContainer, DOM.newStepImportanceInput, e.target.dataset.value));
                DOM.editStarsContainer.addEventListener('click', (e) => e.target.tagName === 'SPAN' && updateStars(DOM.editStarsContainer, DOM.editStepImportanceInput, e.target.dataset.value));
                DOM.saveEditButton.addEventListener('click', saveEditedStep);
                DOM.cancelEditButton.addEventListener('click', closeEditModal);
                DOM.editModalOverlay.addEventListener('click', (e) => e.target === DOM.editModalOverlay && closeEditModal());
                detectAndSetLanguage();
                updateStars(DOM.newStarsContainer, DOM.newStepImportanceInput, 3);
            };

            setupInitialState();
        });
    </script>
</body>
</html>